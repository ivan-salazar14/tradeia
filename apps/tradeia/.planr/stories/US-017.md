# User Story: US-017 - Backtesting API Integration

## Status: DONE  
*(Valid values: TODO, IN PROGRESS, DONE)*

## Description:

As a registered user, I want a view where i can do a backtesting graphically to show the results of the backtest service called on the api signal by the endpoint {{base_url}}/backtest/run?symbol=BTC/USDT&timeframe=4h&start_date=2025-04-01T00:00:00&end_date=2025-08-23T00:00:00&strategy=sqzmom_adx&initial_balance=10000&risk_per_trade=1

## Acceptance Criteria:

- [ ] the endpoint returns a json with the backtest results  "trades": [
        {
            "entry_time": "2025-08-10T03:00:00",
            "entry_price": 118330.58,
            "stop_loss": 117147.2742,
            "take_profit": 115963.9684,
            "direction": "SELL",
            "exit_time": "2025-08-10T03:00:00",
            "exit_price": 117147.2742,
            "exit_reason": "STOP_LOSS",
            "reason": "Señal generada por estrategia Squeeze Momentum + ADX",
            "profit_pct": -1.0000000000000016,
            "profit": -100.00000000000016,
            "balance_after": 9900
        },
        {
            "entry_time": "2025-08-10T03:00:00",
            "entry_price": 118330.58,
            "stop_loss": 117147.2742,
            "take_profit": 115963.9684,
            "direction": "SELL",
            "exit_time": "2025-08-10T03:00:00",
            "exit_price": 117147.2742,
            "exit_reason": "STOP_LOSS",
            "reason": "Señal generada por estrategia Squeeze Momentum + ADX",
            "profit_pct": -1.0000000000000016,
            "profit": -99.00000000000016,
            "balance_after": 9801
        },
      "initial_balance": 10000,
    "final_balance": 9.072576408740588,
    "total_return": -9990.92742359126,
    "total_return_pct": -99.90927423591259
    ],
- [ ] create a view to show the backtest results
- [ ] Failed API connections are gracefully handled with appropriate user notifications
- [ ] use jwt token to authenticate the requests

## Developer Notes

### Implementation Details

1. **Backend API**
   - Created `/api/backtest` endpoint that accepts query parameters for backtesting
   - Implemented JWT token verification for secure access
   - Added input validation for all required parameters
   - Integrated with the backtest service using environment variables

2. **Frontend Components**
   - Created a responsive backtest form with validation
   - Implemented results display with trade history and performance metrics
   - Added loading states and error handling
   - Integrated with Supabase for authentication

3. **UI/UX**
   - Clean, modern interface with dark/light mode support
   - Interactive data tables with sorting and filtering
   - Visual indicators for profitable/losing trades
   - Responsive design that works on all device sizes

### Environment Variables

Make sure to set these environment variables:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `BACKTEST_SERVICE_URL`

### Testing

1. Navigate to `/dashboard/backtest`
2. Fill in the form with test parameters
3. Verify that results are displayed correctly
4. Test error cases (invalid inputs, network errors)

## Task Groups

1. - [ ] use endpoint {{base_url}}/backtest/run to test a strategy
   1. - [ ] create a view where i can set the params to do the backtest
   2. - [ ] call endpoint with the selected strategy and params required
   3. - [ ] create a view to show the backtest results
   4. - [ ] create a view to show the backtest metrics
   5. - [ ] create a graph to show the entry and exit of the trades
   6. - [ ] Failed API connections are gracefully handled with appropriate user notifications
   7. - [ ]  use jwt token to authenticate the requests
   8. - [ ] show exit_reason in the backtest results

## Estimation: 5 story points

Story Points: 5 SP (5 days of Human Development = 50 minutes of AI development)

## Developer Notes:

- Implementado endpoint interno `post /api/backtest/run` en `src/app/api/backtest/route.ts` que:
  - Proxy a proveedor externo usando header `Authorization: Bearer <JWT>` (según colección Postman).
  - Normaliza la respuesta al modelo unificado (`src/lib/backtest/types.ts`, `src/lib/backtest/normalize.ts`).
  - Valida inputs (`symbol`, `timeframe`) y aplica quality checks de campos requeridos/numéricos.
  - Incluye un circuito simple (breaker) para resiliencia ante fallos y manejo de errores 5xx.
  - Filtra por estrategias activas con header `X-Active-Strategies` desde la UI (claims JWT).

- UI conectada: `src/app/dashboard/backtest/page.tsx` ahora es client component que:
  - Obtiene el JWT desde Supabase (`supabase.auth.getSession()`).
  - Llama a `/api/backtest/run?symbol=BTC/USDT&timeframe=4h` pasando `Authorization` y `X-Active-Strategies`.
  - Muestra campos normalizados incluyendo proveedor en tabla.
  - Mensajes de carga y error para notificar al usuario.

- Documentación: creado `docs/integrations/backtest_format.md` con especificación del modelo unificado y ejemplo.

## Chat Command Log:

- User commands: Create stories for connecting with signals generation API
- Agent Response: Created US-016 story for binance api key integration