# User Story: US-017 - Backtesting API Integration

## Status: IN PROGRESS  
*(Valid values: TODO, IN PROGRESS, DONE)*

## Description:

As a registered user, I want a view where i can do a backtesting graphically to show the results of the backtest service called on the api signal by the endpoint {{base_url}}/backtest/run?symbol=BTC/USDT&timeframe=4h&start_date=2025-04-01T00:00:00&end_date=2025-08-23T00:00:00&strategy=sqzmom_adx&initial_balance=10000&risk_per_trade=1

## Acceptance Criteria:

- [ ] the endpoint returns a json with the backtest results "trades": [],
    "metrics": {},
    "equity_curve": [
        {
            "timestamp": "2025-04-01T03:00:00",
            "balance": 10000,
            "position": null
        },
        {
            "timestamp": "2025-04-01T07:00:00",
            "balance": 10000,
            "position": null
        },
        {
            "timestamp": "2025-04-01T11:00:00",
            "balance": 10000,
            "position": null
        },
- [ ] create a view to show the backtest results
- [ ] Failed API connections are gracefully handled with appropriate user notifications
- [ ] use jwt token to authenticate the requests

## Task Groups

1. - [ ] use endpoint {{base_url}}/backtest/run to test a strategy
   1. - [ ] create a view where i can select the strategy to test and params required
   2. - [ ] call endpoint with the selected strategy and params required
   3. - [ ] create a view to show the backtest results
   4. - [ ] create a view to show the backtest metrics
   5. - [ ] create a graph to show the entry and exit of the trades
   6. - [ ] Failed API connections are gracefully handled with appropriate user notifications
   7. - [ ]  use jwt token to authenticate the requests

## Estimation: 5 story points

Story Points: 5 SP (5 days of Human Development = 50 minutes of AI development)

## Developer Notes:

- Implementado endpoint interno `GET /api/signals` en `src/app/api/signals/route.ts` que:
  - Proxy a proveedor externo usando header `Authorization: Bearer <JWT>` (según colección Postman).
  - Normaliza la respuesta al modelo unificado (`src/lib/signals/types.ts`, `src/lib/signals/normalize.ts`).
  - Valida inputs (`symbol`, `timeframe`) y aplica quality checks de campos requeridos/numéricos.
  - Incluye un circuito simple (breaker) para resiliencia ante fallos y manejo de errores 5xx.
  - Filtra por estrategias activas con header `X-Active-Strategies` desde la UI (claims JWT).

- UI conectada: `src/app/dashboard/signals/page.tsx` ahora es client component que:
  - Obtiene el JWT desde Supabase (`supabase.auth.getSession()`).
  - Llama a `/api/signals?symbol=BTC/USDT&timeframe=4h` pasando `Authorization` y `X-Active-Strategies`.
  - Muestra campos normalizados incluyendo proveedor en tabla.
  - Mensajes de carga y error para notificar al usuario.

- Documentación: creado `docs/integrations/signal_format.md` con especificación del modelo unificado y ejemplo.

## Chat Command Log:

- User commands: Create stories for connecting with signals generation API
- Agent Response: Created US-016 story for binance api key integration